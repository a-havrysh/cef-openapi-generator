package {{apiPackage}}.cef;

import com.intellij.openapi.project.Project;
import {{apiPackage}}.routing.RouteTree;
import {{apiPackage}}.protocol.ApiRequest;
import {{apiPackage}}.protocol.ApiResponse;
import {{apiPackage}}.protocol.HttpMethod;
import {{apiPackage}}.exception.ApiException;
{{#apiInfo}}
{{#apis}}
import {{apiPackage}}.service.{{classname}}Service;
{{/apis}}
{{/apiInfo}}
import org.cef.browser.CefBrowser;
import org.cef.browser.CefFrame;
import org.cef.handler.CefResourceHandler;
import org.cef.handler.CefResourceRequestHandlerAdapter;
import org.cef.network.CefRequest;

import java.util.function.Function;

/**
 * Single CEF Resource Request Handler for all APIs.
 * Uses RouteTree for efficient routing, converts ApiResponse to CEF format.
 * Auto-generated from OpenAPI specification.
 */
public final class ApiResourceRequestHandler extends CefResourceRequestHandlerAdapter {

    private final Project project;
    private final RouteTree routeTree;

    public ApiResourceRequestHandler(Project project, RouteTree routeTree) {
        this.project = project;
        this.routeTree = routeTree;
    }

    @Override
    public CefResourceHandler getResourceHandler(CefBrowser browser, CefFrame frame, CefRequest cefRequest) {
        ApiRequest request = new ApiRequest(cefRequest, browser, frame);

        try {
            RouteTree.MatchResult match = routeTree.match(request.getPath(), request.getMethod());
            if (match == null) {
                return null;
            }

            request.setPathVariables(match.pathVariables());

            @SuppressWarnings("unchecked")
            Function<ApiRequest, ApiResponse<?>> handler = (Function<ApiRequest, ApiResponse<?>>) match.handler();
            ApiResponse<?> response = handler.apply(request);

            return ApiResponseHandler.from(response);
        } catch (ApiException e) {
            return ApiResponseHandler.error(e.getStatusCode(), e.getMessage());
        } catch (Exception e) {
            return ApiResponseHandler.error(500, "Internal server error: " + e.getMessage());
        }
    }
}
