package {{apiPackage}}.cef;

import com.intellij.openapi.project.Project;
import {{apiPackage}}.routing.RouteTree;
import {{apiPackage}}.protocol.HttpMethod;
import {{apiPackage}}.protocol.ApiRequest;
import {{apiPackage}}.protocol.ApiResponse;
{{#apiInfo}}
{{#apis}}
import {{apiPackage}}.service.{{classname}}Service;
{{/apis}}
{{/apiInfo}}

import java.util.function.Function;

/**
 * Builder for ApiCefRequestHandler with fluent API.
 * Allows adding custom routes alongside generated API routes.
 * Auto-generated from OpenAPI specification.
 *
 * <p>Usage example:</p>
 * <pre>{@code
 * ApiCefRequestHandler handler = ApiApiCefRequestHandlerBuilder.builder(project)
 *     .withApiRoutes()
 *     .withPrefix("/custom", request -> ApiResponse.ok("Custom response"))
 *     .build();
 * }</pre>
 */
public final class ApiApiCefRequestHandlerBuilder {

    private final Project project;
    private final RouteTree routeTree = new RouteTree();

    private ApiApiCefRequestHandlerBuilder(Project project) {
        this.project = project;
    }

    /**
     * Create a new builder instance.
     *
     * @param project IntelliJ project instance
     * @return new ApiApiCefRequestHandlerBuilder
     */
    public static ApiApiCefRequestHandlerBuilder builder(Project project) {
        return new ApiApiCefRequestHandlerBuilder(project);
    }

    /**
     * Add all generated API routes from OpenAPI specification.
     * Registers route handlers for each operation defined in the spec.
     *
     * @return this builder for chaining
     */
    public ApiApiCefRequestHandlerBuilder withApiRoutes() {
{{#apiInfo}}
{{#apis}}
{{#operations}}
{{#operation}}
        routeTree.addRoute("{{path}}", HttpMethod.{{httpMethod}}, request -> {
            {{classname}}Service service = project.getService({{classname}}Service.class);
            return service.handle{{#lambda.titlecase}}{{operationId}}{{/lambda.titlecase}}(request);
        });
{{/operation}}
{{/operations}}
{{/apis}}
{{/apiInfo}}
        return this;
    }

    /**
     * Add prefix route that matches if path starts with the specified prefix.
     * Useful for handling entire API namespaces or static file directories.
     *
     * @param prefix  URL prefix to match (e.g., "/api/v1", "/static")
     * @param handler function to process matching requests
     * @return this builder for chaining
     */
    public ApiApiCefRequestHandlerBuilder withPrefix(String prefix, Function<ApiRequest, ApiResponse<?>> handler) {
        routeTree.addPrefixRoute(prefix, handler);
        return this;
    }

    /**
     * Add exact route that matches only if path equals exactly.
     * Provides precise routing for specific endpoints.
     *
     * @param path    exact URL path to match (e.g., "/health", "/api/status")
     * @param handler function to process matching requests
     * @return this builder for chaining
     */
    public ApiApiCefRequestHandlerBuilder withExact(String path, Function<ApiRequest, ApiResponse<?>> handler) {
        routeTree.addExactRoute(path, handler);
        return this;
    }

    /**
     * Add contains route that matches if path contains the specified substring.
     * Useful for wildcard-like matching patterns.
     *
     * @param substring substring to search for in path (e.g., ".json", "/admin/")
     * @param handler   function to process matching requests
     * @return this builder for chaining
     */
    public ApiApiCefRequestHandlerBuilder withContains(String substring, Function<ApiRequest, ApiResponse<?>> handler) {
        routeTree.addContainsRoute(substring, handler);
        return this;
    }

    /**
     * Build ApiCefRequestHandler with all configured routes.
     * Creates the final request handler ready for use with CEF browser.
     *
     * @return configured ApiCefRequestHandler instance
     */
    public ApiCefRequestHandler build() {
        return new ApiCefRequestHandler(project, routeTree);
    }
}
