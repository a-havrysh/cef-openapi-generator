package {{apiPackage}}.cef;

import com.intellij.openapi.project.Project;
import {{apiPackage}}.routing.RouteTree;
import {{apiPackage}}.protocol.HttpMethod;
import org.cef.browser.CefBrowser;
import org.cef.browser.CefFrame;
import org.cef.handler.CefRequestHandlerAdapter;
import org.cef.handler.CefResourceRequestHandler;
import org.cef.network.CefRequest;
import java.util.List;
import org.cef.misc.BoolRef;

/**
 * Main CEF Request Handler with builder support.
 * Intercepts HTTP requests in CEF browser and delegates to registered route handlers.
 * Auto-generated from OpenAPI specification.
 *
 * <p>This handler extends {@link CefRequestHandlerAdapter} and provides routing
 * capabilities for API endpoints. Use the builder pattern for configuration.</p>
 *
 * <p>Usage example:</p>
 * <pre>{@code
 * ApiCefRequestHandler handler = ApiCefRequestHandler.builder(project)
 *     .withApiRoutes()
 *     .build();
 * }</pre>
 *
 * @see ApiCefRequestHandlerBuilder
 * @see ApiResourceRequestHandler
 */
public final class ApiCefRequestHandler extends CefRequestHandlerAdapter {

    private final ApiResourceRequestHandler apiHandler;
    private final RouteTree routeTree;
    private final List<String> urlPrefixes;

    /**
     * Package-private constructor for builder use only.
     *
     * @param project          IntelliJ project instance
     * @param routeTree        configured route tree with all registered handlers
     * @param urlPrefixes      allowed URL prefixes for filtering (null = accept all URLs)
     * @param interceptors     request/response interceptors for cross-cutting concerns
     * @param exceptionHandler exception handler for centralized error handling
     */
    ApiCefRequestHandler(Project project, RouteTree routeTree, List<String> urlPrefixes, List<{{apiPackage}}.interceptor.RequestInterceptor> interceptors, {{apiPackage}}.interceptor.ExceptionHandler exceptionHandler) {
        this.apiHandler = new ApiResourceRequestHandler(project, routeTree, interceptors, exceptionHandler);
        this.routeTree = routeTree;
        this.urlPrefixes = urlPrefixes;
    }

    /**
     * Create a new builder for configuring ApiCefRequestHandler.
     *
     * @param project IntelliJ project instance
     * @return new ApiCefRequestHandlerBuilder
     */
    public static ApiCefRequestHandlerBuilder builder(Project project) {
        return ApiCefRequestHandlerBuilder.builder(project);
    }

    /**
     * Handle resource requests by routing to registered handlers.
     * Called by CEF when browser makes an HTTP request.
     *
     * @param browser               CEF browser instance
     * @param frame                 CEF frame making the request
     * @param request               HTTP request details
     * @param isNavigation          true if this is a navigation request
     * @param isDownload            true if this is a download request
     * @param requestInitiator      origin of the request
     * @param disableDefaultHandling flag to disable default CEF handling
     * @return resource handler if route matches, null otherwise
     */
    @Override
    public CefResourceRequestHandler getResourceRequestHandler(
            CefBrowser browser,
            CefFrame frame,
            CefRequest request,
            boolean isNavigation,
            boolean isDownload,
            String requestInitiator,
            BoolRef disableDefaultHandling) {

        String url = request.getURL();

        // Apply URL filtering if configured
        if (urlPrefixes != null && !matchesUrlFilter(url)) {
            return null; // Browser handles non-whitelisted URLs
        }

        String path = extractPath(url);
        HttpMethod method = HttpMethod.valueOf(request.getMethod());

        if (routeTree.match(path, method) != null) {
            return apiHandler;
        }

        return null;
    }

    /**
     * Extract path component from full URL.
     *
     * @param url full URL string
     * @return path component, or empty string if parsing fails
     */
    private String extractPath(String url) {
        try {
            java.net.URI uri = new java.net.URI(url);
            return uri.getPath();
        } catch (Exception e) {
            return "";
        }
    }

    /**
     * Check if URL matches any configured prefix (whitelist mode).
     *
     * @param url full URL to check
     * @return true if URL matches any prefix, false otherwise
     */
    private boolean matchesUrlFilter(String url) {
        if (url == null || urlPrefixes.isEmpty()) {
            return false;
        }

        return urlPrefixes.stream().anyMatch(url::startsWith);
    }
}
