package {{apiPackage}}.cef;

import com.intellij.openapi.project.Project;
import {{apiPackage}}.routing.RouteTree;
import {{apiPackage}}.protocol.ApiRequest;
import {{apiPackage}}.protocol.ApiResponse;
import {{apiPackage}}.protocol.HttpMethod;
import {{apiPackage}}.exception.ApiException;
import org.cef.browser.CefBrowser;
import org.cef.browser.CefFrame;
import org.cef.handler.CefResourceHandler;
import org.cef.handler.CefResourceRequestHandlerAdapter;
import org.cef.network.CefRequest;

import java.util.List;

/**
 * Single CEF Resource Request Handler for all APIs.
 * Uses RouteTree for efficient routing, converts ApiResponse to CEF format.
 * Auto-generated from OpenAPI specification.
 *
 * <p>This handler processes matched API requests by:</p>
 * <ul>
 *   <li>Converting CEF request to ApiRequest</li>
 *   <li>Finding matching route handler in RouteTree</li>
 *   <li>Extracting path variables from URL patterns</li>
 *   <li>Executing the handler function</li>
 *   <li>Converting ApiResponse to CEF ResourceHandler</li>
 *   <li>Handling errors with appropriate HTTP status codes</li>
 * </ul>
 *
 * @see ApiRequest
 * @see ApiResponse
 * @see ApiResponseHandler
 * @see RouteTree
 */
public final class ApiResourceRequestHandler extends CefResourceRequestHandlerAdapter {

    private final Project project;
    private final RouteTree routeTree;
    private final List<{{apiPackage}}.interceptor.RequestInterceptor> interceptors;
    private final {{apiPackage}}.interceptor.ExceptionHandler exceptionHandler;

    /**
     * Package-private constructor for CefRequestHandler use only.
     *
     * @param project          IntelliJ project instance for service access
     * @param routeTree        configured route tree with all registered handlers
     * @param interceptors     request/response interceptors
     * @param exceptionHandler exception handler for centralized error handling
     */
    public ApiResourceRequestHandler(Project project, RouteTree routeTree, List<{{apiPackage}}.interceptor.RequestInterceptor> interceptors, {{apiPackage}}.interceptor.ExceptionHandler exceptionHandler) {
        this.project = project;
        this.routeTree = routeTree;
        this.interceptors = interceptors != null ? interceptors : java.util.Collections.emptyList();
        this.exceptionHandler = exceptionHandler != null ? exceptionHandler : {{apiPackage}}.interceptor.ExceptionHandler.DEFAULT;
    }

    /**
     * Process resource request by matching route and executing handler.
     * Converts ApiResponse to CEF ResourceHandler format.
     *
     * <p>Error handling:</p>
     * <ul>
     *   <li>{@link ApiException} - returns error with exception's status code</li>
     *   <li>Other exceptions - returns 500 Internal Server Error</li>
     * </ul>
     *
     * @param browser    CEF browser instance
     * @param frame      CEF frame making the request
     * @param cefRequest HTTP request details
     * @return CEF resource handler with response data, or error handler if processing fails
     */
    @Override
    public CefResourceHandler getResourceHandler(CefBrowser browser, CefFrame frame, CefRequest cefRequest) {
        ApiRequest request = new ApiRequest(cefRequest, browser, frame);
        long startTime = System.currentTimeMillis();

        try {
            RouteTree.MatchResult match = routeTree.match(request.getPath(), request.getMethod());
            if (match == null) {
                return null;
            }

            request.setPathVariables(match.pathVariables());

            // Call beforeHandle interceptors
            for ({{apiPackage}}.interceptor.RequestInterceptor interceptor : interceptors) {
                interceptor.beforeHandle(request);
            }

            // Execute handler
            ApiResponse<?> response = match.handler().apply(request);

            // Call afterHandle interceptors
            long duration = System.currentTimeMillis() - startTime;
            for ({{apiPackage}}.interceptor.RequestInterceptor interceptor : interceptors) {
                try {
                    interceptor.afterHandle(response, duration);
                } catch (Exception e) {
                    // Log but don't fail the request
                    System.err.println("Interceptor afterHandle error: " + e.getMessage());
                }
            }

            return ApiResponseHandler.from(response);
        } catch (Exception e) {
            // Call onError interceptors
            for ({{apiPackage}}.interceptor.RequestInterceptor interceptor : interceptors) {
                try {
                    interceptor.onError(e, request);
                } catch (Exception ex) {
                    System.err.println("Interceptor onError failed: " + ex.getMessage());
                }
            }

            // Use exception handler for error response
            ApiResponse<?> errorResponse = exceptionHandler.handleException(e, cefRequest);
            return ApiResponseHandler.from(errorResponse);
        }
    }
}
