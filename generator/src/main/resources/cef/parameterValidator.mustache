package {{apiPackage}}.validation;

import {{apiPackage}}.exception.ValidationException.ValidationError;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Pattern;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * Utility class for validating request parameters against OpenAPI constraints.
 *
 * <p>Provides thread-safe, stateless validation methods for different parameter types.
 * All methods return a list of {@link ValidationError} objects, allowing collection
 * of all validation failures before throwing an exception.
 *
 * <p>Supported validations:
 * <ul>
 *   <li>String constraints: required, minLength, maxLength, pattern (regex), enum</li>
 *   <li>Integer constraints: required, minimum, maximum</li>
 *   <li>Number constraints: required, minimum, maximum</li>
 * </ul>
 *
 * <p>Performance optimizations:
 * <ul>
 *   <li>Regex patterns are compiled once and cached in a thread-safe map</li>
 *   <li>All methods are static to avoid object allocation overhead</li>
 * </ul>
 *
 * <p>Auto-generated from OpenAPI specification.
 *
 * @see ValidationError
 */
public final class ParameterValidator {

    private ParameterValidator() {
        // Prevent instantiation
    }

    // Cache for compiled regex patterns (thread-safe)
    private static final Map<String, Pattern> PATTERN_CACHE = new ConcurrentHashMap<>();

    /**
     * Validates a string parameter against OpenAPI constraints.
     *
     * <p>Validation order:
     * <ol>
     *   <li>Required check - if fails, returns immediately</li>
     *   <li>Skip all other validations if value is null (optional parameter)</li>
     *   <li>MinLength, MaxLength, Pattern, Enum validations (all failures collected)</li>
     * </ol>
     *
     * @param paramName parameter name for error messages
     * @param value parameter value to validate (may be null)
     * @param required whether parameter is required
     * @param minLength minimum string length (null if no constraint)
     * @param maxLength maximum string length (null if no constraint)
     * @param pattern regex pattern (null if no constraint)
     * @param enumValues allowed values (null if no constraint)
     * @return list of validation errors (empty if valid)
     */
    public static List<ValidationError> validateString(
            String paramName,
            String value,
            boolean required,
            Integer minLength,
            Integer maxLength,
            String pattern,
            List<String> enumValues) {

        List<ValidationError> errors = new ArrayList<>();

        // Required check
        if (required && (value == null || value.isEmpty())) {
            errors.add(new ValidationError(paramName, value, "required",
                paramName + " is required"));
            return errors; // Don't validate other constraints if missing
        }

        // Skip other validations if value is null (optional parameter)
        if (value == null) {
            return errors;
        }

        // MinLength
        if (minLength != null && value.length() < minLength) {
            errors.add(new ValidationError(paramName, value, "minLength",
                paramName + " must be at least " + minLength + " characters (got " + value.length() + ")"));
        }

        // MaxLength
        if (maxLength != null && value.length() > maxLength) {
            errors.add(new ValidationError(paramName, value, "maxLength",
                paramName + " must be at most " + maxLength + " characters (got " + value.length() + ")"));
        }

        // Pattern
        if (pattern != null) {
            Pattern compiledPattern = PATTERN_CACHE.computeIfAbsent(pattern, Pattern::compile);
            if (!compiledPattern.matcher(value).matches()) {
                errors.add(new ValidationError(paramName, value, "pattern",
                    paramName + " must match pattern: " + pattern));
            }
        }

        // Enum
        if (enumValues != null && !enumValues.isEmpty() && !enumValues.contains(value)) {
            errors.add(new ValidationError(paramName, value, "enum",
                paramName + " must be one of: " + String.join(", ", enumValues)));
        }

        return errors;
    }

    /**
     * Validates an integer parameter against OpenAPI constraints.
     *
     * <p>Validation order:
     * <ol>
     *   <li>Required check - if fails, returns immediately</li>
     *   <li>Skip all other validations if value is null (optional parameter)</li>
     *   <li>Minimum, Maximum validations (all failures collected)</li>
     * </ol>
     *
     * @param paramName parameter name for error messages
     * @param value parameter value to validate (may be null)
     * @param required whether parameter is required
     * @param minimum minimum value (null if no constraint)
     * @param maximum maximum value (null if no constraint)
     * @return list of validation errors (empty if valid)
     */
    public static List<ValidationError> validateInteger(
            String paramName,
            Integer value,
            boolean required,
            Integer minimum,
            Integer maximum) {

        List<ValidationError> errors = new ArrayList<>();

        if (required && value == null) {
            errors.add(new ValidationError(paramName, null, "required",
                paramName + " is required"));
            return errors;
        }

        if (value == null) {
            return errors;
        }

        if (minimum != null && value < minimum) {
            errors.add(new ValidationError(paramName, value, "minimum",
                paramName + " must be at least " + minimum + " (got " + value + ")"));
        }

        if (maximum != null && value > maximum) {
            errors.add(new ValidationError(paramName, value, "maximum",
                paramName + " must be at most " + maximum + " (got " + value + ")"));
        }

        return errors;
    }

    /**
     * Validates a number (double/float) parameter against OpenAPI constraints.
     *
     * <p>Validation order:
     * <ol>
     *   <li>Required check - if fails, returns immediately</li>
     *   <li>Skip all other validations if value is null (optional parameter)</li>
     *   <li>Minimum, Maximum validations (all failures collected)</li>
     * </ol>
     *
     * @param paramName parameter name for error messages
     * @param value parameter value to validate (may be null)
     * @param required whether parameter is required
     * @param minimum minimum value (null if no constraint)
     * @param maximum maximum value (null if no constraint)
     * @return list of validation errors (empty if valid)
     */
    public static List<ValidationError> validateNumber(
            String paramName,
            Number value,
            boolean required,
            Number minimum,
            Number maximum) {

        List<ValidationError> errors = new ArrayList<>();

        if (required && value == null) {
            errors.add(new ValidationError(paramName, null, "required",
                paramName + " is required"));
            return errors;
        }

        if (value == null) {
            return errors;
        }

        double doubleValue = value.doubleValue();

        if (minimum != null && doubleValue < minimum.doubleValue()) {
            errors.add(new ValidationError(paramName, value, "minimum",
                paramName + " must be at least " + minimum + " (got " + value + ")"));
        }

        if (maximum != null && doubleValue > maximum.doubleValue()) {
            errors.add(new ValidationError(paramName, value, "maximum",
                paramName + " must be at most " + maximum + " (got " + value + ")"));
        }

        return errors;
    }

    /**
     * Parses a string to integer and validates constraints in one step.
     *
     * <p>This method is specifically designed for query/path/header parameters
     * which are extracted as strings but represent integer values.
     *
     * <p>Validation order:
     * <ol>
     *   <li>Required check - if fails, returns immediately</li>
     *   <li>Type check - attempts to parse as integer, fails if invalid format</li>
     *   <li>Delegates to {@link #validateInteger} for min/max validation</li>
     * </ol>
     *
     * @param paramName parameter name for error messages
     * @param stringValue parameter value as string (may be null)
     * @param required whether parameter is required
     * @param minimum minimum value (null if no constraint)
     * @param maximum maximum value (null if no constraint)
     * @return list of validation errors (empty if valid)
     */
    public static List<ValidationError> validateAndParseInteger(
            String paramName,
            String stringValue,
            boolean required,
            Integer minimum,
            Integer maximum) {

        List<ValidationError> errors = new ArrayList<>();

        if (required && (stringValue == null || stringValue.isEmpty())) {
            errors.add(new ValidationError(paramName, stringValue, "required",
                paramName + " is required"));
            return errors;
        }

        if (stringValue == null || stringValue.isEmpty()) {
            return errors;
        }

        Integer value;
        try {
            value = Integer.parseInt(stringValue);
        } catch (NumberFormatException e) {
            errors.add(new ValidationError(paramName, stringValue, "type",
                paramName + " must be a valid integer"));
            return errors;
        }

        return validateInteger(paramName, value, false, minimum, maximum);
    }

    /**
     * Parses a string to number (double) and validates constraints in one step.
     *
     * <p>This method is specifically designed for query/path/header parameters
     * which are extracted as strings but represent numeric values.
     *
     * <p>Validation order:
     * <ol>
     *   <li>Required check - if fails, returns immediately</li>
     *   <li>Type check - attempts to parse as double, fails if invalid format</li>
     *   <li>Delegates to {@link #validateNumber} for min/max validation</li>
     * </ol>
     *
     * @param paramName parameter name for error messages
     * @param stringValue parameter value as string (may be null)
     * @param required whether parameter is required
     * @param minimum minimum value (null if no constraint)
     * @param maximum maximum value (null if no constraint)
     * @return list of validation errors (empty if valid)
     */
    public static List<ValidationError> validateAndParseNumber(
            String paramName,
            String stringValue,
            boolean required,
            Number minimum,
            Number maximum) {

        List<ValidationError> errors = new ArrayList<>();

        if (required && (stringValue == null || stringValue.isEmpty())) {
            errors.add(new ValidationError(paramName, stringValue, "required",
                paramName + " is required"));
            return errors;
        }

        if (stringValue == null || stringValue.isEmpty()) {
            return errors;
        }

        Double value;
        try {
            value = Double.parseDouble(stringValue);
        } catch (NumberFormatException e) {
            errors.add(new ValidationError(paramName, stringValue, "type",
                paramName + " must be a valid number"));
            return errors;
        }

        return validateNumber(paramName, value, false, minimum, maximum);
    }
}
