package {{apiPackage}}.interceptor;

import {{apiPackage}}.protocol.ApiRequest;
import {{apiPackage}}.protocol.ApiResponse;

import java.util.Map;

/**
 * Interceptor for request/response processing.
 * Allows pre/post processing of all API requests for cross-cutting concerns.
 *
 * <p>Use cases:</p>
 * <ul>
 *   <li>Logging - log all requests and responses</li>
 *   <li>Metrics - track request count, duration, errors</li>
 *   <li>Authentication - validate tokens, sessions</li>
 *   <li>Authorization - check permissions</li>
 *   <li>Request ID tracking - correlation across logs</li>
 *   <li>Rate limiting - throttle excessive requests</li>
 * </ul>
 *
 * <p>Execution order:</p>
 * <pre>
 * 1. beforeHandle() called before route handler
 * 2. Route handler executes
 * 3. afterHandle() called after successful handling
 * 4. onError() called if exception occurs
 * </pre>
 *
 * <p>Example implementation:</p>
 * <pre>{@code
 * public class LoggingInterceptor implements RequestInterceptor {
 *     @Override
 *     public void beforeHandle(ApiRequest request) {
 *         System.out.println("Request: " + request.getMethod() + " " + request.getPath());
 *         String userId = request.getPathVariable("userId");  // Access path variables from request
 *     }
 *
 *     @Override
 *     public void afterHandle(ApiResponse<?> response, long durationMs) {
 *         System.out.println("Response: " + response.getStatusCode() + " (" + durationMs + "ms)");
 *     }
 *
 *     @Override
 *     public void onError(Exception e, ApiRequest request) {
 *         System.err.println("Error handling " + request.getPath() + ": " + e.getMessage());
 *     }
 * }
 * }</pre>
 *
 * <p>Register interceptor in builder:</p>
 * <pre>{@code
 * ApiCefRequestHandler handler = ApiCefRequestHandler.builder(project)
 *     .withApiRoutes()
 *     .withInterceptor(new LoggingInterceptor())
 *     .withInterceptor(new MetricsInterceptor())
 *     .build();
 * }</pre>
 *
 * <p><b>Thread Safety:</b> Interceptors must be thread-safe as they may be called
 * from multiple threads simultaneously.</p>
 *
 * @see ApiResponse
 */
public interface RequestInterceptor {

    /**
     * Called before route handler execution.
     * Can be used for logging, authentication, request modification, validation.
     *
     * <p><b>Breaking Change (v2.0.0):</b> Changed from CefRequest to ApiRequest to provide
     * better access to query parameters, headers, and request body. Removed pathVariables
     * parameter - use request.getPathVariable(name) instead.
     *
     * @param request API request being processed (with access to query params, headers, body, path variables)
     * @throws Exception to abort request processing and return error response
     */
    default void beforeHandle(ApiRequest request) throws Exception {
        // Default: no-op
    }

    /**
     * Called after successful route handler execution.
     * Can be used for logging, metrics, response modification.
     *
     * @param response   generated API response
     * @param durationMs request processing duration in milliseconds
     */
    default void afterHandle(ApiResponse<?> response, long durationMs) {
        // Default: no-op
    }

    /**
     * Called when exception occurs during request processing.
     * Can be used for error logging, metrics, alerting.
     *
     * <p><b>Breaking Change (v2.0.0):</b> Changed from CefRequest to ApiRequest.
     *
     * @param exception exception that occurred
     * @param request   API request that caused the exception
     */
    default void onError(Exception exception, ApiRequest request) {
        // Default: no-op
    }
}
